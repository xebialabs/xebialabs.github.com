<html><head><LINK REL=StyleSheet HREF="css/deployit.css" TYPE="text/css" MEDIA=screen>
<LINK REL=StyleSheet HREF="css/ci-reference-api.css" TYPE="text/css" MEDIA=screen>
<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="js/jquery.tableofcontents.min.js"></script>
<script type="text/javascript" charset="utf-8">
$(document).ready(function(){
    $("body").attr('id', 'top-toc');
    var title = $("<div class='manual-title'/>")
    title.html("<div class='title'>Upgrade Manual</div><div class='version'>Version <span class='version-number'>3.7.0-beta-1</span></div>");
    $("body").css('width', '100%');
    $("body").prepend(title);
    $("body").prepend($("<ol id='toc'/>"));
    $("#toc").tableOfContents("body", { topLinks: true, } );
});

</script>
<title>Upgrade Manual</title>
</head><body><h1>Preface</h1><p>This manual describes how to upgrade from a previous version of Deployit.</p><h1>The upgrade process</h1><p>Overall, the upgrade process consists of the following steps:</p>
<ul>
  <li>Obtain a new version of the Deployit software (the main product and/or plugins) from XebiaLabs.</li>
  <li>Read the new version's <strong>release notes</strong> so you are aware of the new functionality and possible upgrade considerations.</li>
  <li>Read the new version's <strong>upgrade manual</strong> (this document) so you are aware of possible upgrade considerations.</li>
  <li>Stop the current version of Deployit if it is still running.</li>
  <li>Create a brand-new installation directory for the new version of Deployit so the existing version is still available in case of problems.</li>
  <li>Extract the new Deployit software release into the new installation directory.</li>
  <li>Copy the data from the previous Deployit installation directory into the new installation directory.</li>
  <li>Start the new version of Deployit.</li>
</ul><h1>Upgrade notes</h1>
<ul>
  <li>It is possible to skip Deployit versions when upgrading. Deployit will sequentially apply any upgrades for the intermediate (skipped) versions. <strong>Please read the specific upgrade instructions for each of the versions carefully.</strong></li>
  <li>The new version of Deployit may not be compatible with the existing version of your plugins. If this is the case, you'll need to download an updated version of your plugin as well. <strong>Please read the specific upgrade instructions for each of the versions carefully.</strong></li>
  <li>If a repository upgrade is required, Deployit will detect that it is running against an old repository and will automatically execute an upgrade when it is first started. The server log will contain extensive logging of the repository upgrade process.</li>
  <li>Plugin versions are related to the version of Deployit that they are compatible with. For instance, WAS plugin version 3.6.0 requires <strong>at least</strong> Deployit server version 3.6.0. This version of the WAS plugin should also work in Deployit 3.7.0 unless stated otherwise in this document.</li>
</ul><h1>Performing the upgrade</h1><p>To begin upgrading Deployit, first unpack the distribution archive. The distribution archive contains the following:</p>
<ul>
  <li>A server archive.</li>
  <li>A CLI archive.</li>
</ul><p>The release notes are stored in the server's <strong>doc</strong> directory. Please read them carefully before performing the upgrade.</p><h2>Upgrading the Server</h2><p>To upgrade an existing Deployit server installation, do the following:</p>
<ol>
  <li>Create a directory for the new Deployit server installation, including the new Deployit server version number in the directory name.</li>
  <li>Extract the server archive in this directory.</li>
  <li>Copy the contents of the <strong>conf</strong> directory from the previous installation into the new installation directory.</li>
  <li>Copy the contents of the <strong>repository</strong> directory from the previous installation into the new installation directory.</li>
  <li>Copy the contents of the <strong>importablePackages</strong> directory from the previous installation into the new installation directory.</li>
  <li>Copy the contents of the <strong>plugins</strong> directory from the previous installation into the new installation directory.</li>
  <li>Copy the contents of the <strong>ext</strong> directory from the previous installation into the new installation directory.</li>
  <li><strong>DO NOT</strong> copy the contents of the <strong>hotfix</strong> directory (unless instructed) because hotfixes are version specific.</li>
  <li>If you have made any changes to the Deployit server startup scripts (<em>server.sh</em> or <em>server.cmd</em>), copy these from the <strong>bin</strong> directory in the previous installation into the new installation directory.</li>
</ol><p><strong>Note</strong>: please make sure that the plugins and extensions in the old Deployit installation are compatible with the new Deployit server version.</p><p>This completes upgrading of the Deployit server.</p><h2>Upgrading the CLI</h2><p>To upgrade an existing Deployit CLI installation, do the following:</p>
<ol>
  <li>Create a directory for the new Deployit CLI installation, including the new Deployit CLI version number in the directory name.</li>
  <li>Extract the CLI archive in this directory.</li>
  <li>Copy the contents of the <strong>plugins</strong>, <strong>ext</strong> and <strong>hotfix</strong> directories from the previous installation into the new installation directory.</li>
  <li>If you have made any changes to the Deployit CLI startup scripts (<em>cli.sh</em> or <em>cli.cmd</em>), copy these from the <strong>bin</strong> directory in the previous installation into the new installation directory.</li>
</ol><p>This completes upgrading of the Deployit CLI.</p><h1>Specific upgrade notes</h1><p>This section describes specific considerations for migrating from or to a particular Deployit version.</p><h2>Upgrading from Deployit 3.0 or earlier</h2><p>Deployit and the plugins were changed extensively in version 3.5. As a consequence, it is <strong>not</strong> possible to automatically migrate from a 3.0 or earlier version to version 3.5 or later. If you want to perform this type of upgrade, please contact the XebiaLabs support team.</p><h2>Upgrading from Deployit 3.5 to Deployit 3.6</h2>
<ul>
  <li>Deployit 3.6 is a drop-in replacement for Deployit 3.5. No repository migration is needed.</li>
  <li>New versions of the following plugins are needed:
  <ul>
    <li>WAS plugin</li>
    <li>WLS plugin</li>
  </ul></li>
</ul><h2>Upgrading from Deployit 3.5 or 3.6 to Deployit 3.7</h2>
<ul>
  <li>Deployit 3.7 contains an updated security implementation. Data from a pre-3.7 repository will automatically be converted to the new security model. See the section below for a complete description of the security upgrade.</li>
  <li>New versions of the following plugins are needed:</li>
  <li>WAS</li>
  <li>WLS</li>
  <li>Tomcat</li>
  <li>JBoss</li>
  <li>more?</li>
</ul><h3>Security upgrade</h3><p><strong>Permissions and repository</strong></p><p>Starting with Deployit 3.7, Deployit needs to know the admin user's password to access the repository. This must be entered in the <code>deployit.conf</code> file prior to starting the new Deployit server. Note that the password in the configuration file is encrypted by the Deployit server when it starts.</p><p>The main change in the Deployit 3.7 security model is that local security permissions are stored only on root nodes and <em>core.Directory</em> CIs. During the upgrade, Deployit will convert pre-3.7-style permissions to the new permission system and automatically create directories to attach the relevant permissions to. The server log contains a description of the old security information that was found and how this was translated to the new permission system.</p><p>Permissions in Deployit are now assigned to <strong>roles</strong> instead of directly to principals. Deployit itself contains the definitions of roles and the principals they map to. Deployit will create a role for every user it finds during the upgrade.</p><p>It is also no longer possible to globally grant certain permissions. Permissions <em>deploy#initial</em>, <em>deploy#upgrade</em>, <em>deploy#undeploy</em>, <em>import#initial</em>, <em>import#upgrade</em>, <em>task#skip_step</em>, <em>task#move_step</em> can now only be granted on a directory CI. Deployit will convert these global permissions into directory permissions during the upgrade.</p><p>Deployit 3.7 no longer allows <strong>deny</strong> permissions. Instead, permissions should be segregated using the new <strong>core.Directory</strong> grouping CIs. The <strong>deny</strong> permissions are not migrated by Deployit and an equivalent configuration must be created manually.</p><p><strong>LDAP</strong></p><p>Configuration of LDAP security has also changed. The configuration in 3.7 is specified in a file called <em>deployit-security.xml</em>. The 3.6-style LDAP configuration in the <em>jackrabbit-jaas.config</em> file can be migrated easily to the 3.7 format. The following table describes the mapping of the 3.6-style LDAP setup to the new 3.7 setup:</p>
<table class="deployed-matrix">
<tr>
	<th>3.6 example</th>
	<th>3.7 XML element</th>
	<th>3.7 XML properties</th>
	<th>3.7 example</th>
</tr>
<tr>
	<td>userProvider="ldap://localhost:389/ou=system"</td>
	<td>security:ldap-server</td>
	<td>url and root properties</td>
	<td>&lt;security:ldap-server id="ldapServer" url="ldap://localhost:389/" root="ou=system"/&gt;</td>
</tr>
<tr>
	<td>userFilter="(&amp;(uid={USERNAME})(objectClass=inetOrgPerson))"</td>
	<td>security:ldap-authentication-provider</td>
	<td>user-search-filter</td>
	<td>user-search-filter="(&amp;(uid={0})(objectClass=inetOrgPerson))"</td>
</tr>
<tr>
	<td>userSearchBase="dc=example,dc=com"</td>
	<td>security:ldap-authentication-provider</td>
	<td>user-search-base</td>
	<td>user-search-base="dc=example,dc=com"</td>
</tr>
<tr>
	<td>groupFilter="(memberUid={USERNAME})"</td>
	<td>security:ldap-authentication-provider</td>
	<td>group-search-filter</td>
	<td>group-search-filter="(memberUid={0})"</td>
</tr>
<tr>
	<td>groupSearchBase="ou=groups,dc=example,dc=com"</td>
	<td>security:ldap-authentication-provider</td>
	<td>group-search-base</td>
	<td>group-search-base="ou=groups,dc=example,dc=com"</td>
</tr>
<tr>
	<td>java.naming.security.principal="cn=admin,dc=example,dc=com"</td>
	<td>security:ldap-server</td>
	<td>manager-dn</td>
	<td>&lt;security:ldap-server id="ldapServer" url="ldap://localhost:389/" manager-dn="cn=admin,dc=example,dc=com" manager-password="secret"/&gt;</td>
</tr>
<tr>
	<td>java.naming.security.credentials="secret"</td>
	<td>security:ldap-server</td>
	<td>manager-password</td>
	<td>&lt;security:ldap-server id="ldapServer" url="ldap://localhost:389/" manager-dn="cn=admin,dc=example,dc=com" manager-password="secret"/&gt;</td>
</tr>
<tr>
	<td>useSSL</td>
	<td>security:ldap-server</td>
	<td>url</td>
	<td>Use the LDAPS protocol in the url, for example: &lt;security:ldap-server id="ldapServer" url="ldaps://localhost:686/"/&gt;</td>
</tr>
<tr>
	<td>principalProvider=com.xebialabs.deployit.security.LdapPrincipalProvider</td>
	<td>n/a</td>
	<td>n/a</td>
	<td>This element is no longer required.</td>
</tr>
</table><p>See the <strong>System Administration manual</strong> for more details on the available LDAP configuration options.</p><p><strong>Completing the migration</strong></p><p>After the Deployit automated upgrade completes, log in to the Deployit GUI with various credentials to ensure that the security setup was correctly migrated. It is now possible to see the security permissions on <em>directory</em> CIs in the Repository Browser.</p><h3>Additional upgrade steps</h3><p>After completing the upgrade procedure described in <strong>Upgrading the Server</strong> above, perform the following additional steps:</p>
<ol>
  <li>Edit the <code>deployit.conf</code> file and enter the admin password to property <code>admin.password</code>.</li>
  <li>If you use LDAP, migrate the LDAP configuration to the <em>deployit-security.xml</em> configuration file.</li>
  <li>Create a backup of your repository.</li>
  <li>Start the Deployit server. When the server starts, Deployit will migrate the security information from the 3.6 repository to the 3.7 structure. In this process, Deployit will automatically create a role for each user in Deployit as well as special <em>core.Directory</em> CIs to assign permissions to.</li>
  <li>Log into Deployit as the admin user and inspect the changes to the repository.</li>
  <li>Open the Admin tab to create meaningful role assignments.</li>
  <li>Open the Repository tab to create meaningful directory names.</li>
</ol></body></html>